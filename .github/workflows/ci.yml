name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t home-device-bridge:ci .

  deploy:
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    env:
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_PORT: ${{ secrets.SERVER_PORT }}
      SERVER_DEPLOY_PATH: ${{ secrets.SERVER_DEPLOY_PATH }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start ssh-agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Validate deploy settings
        run: |
          : "${SERVER_HOST:?Missing SERVER_HOST}"
          : "${SERVER_USER:?Missing SERVER_USER}"
          : "${SERVER_DEPLOY_PATH:?Missing SERVER_DEPLOY_PATH}"

      - name: Add server to known_hosts
        run: ssh-keyscan -p "${SERVER_PORT:-22}" "$SERVER_HOST" >> ~/.ssh/known_hosts

      - name: Sync sources to server
        run: |
          ssh -p "${SERVER_PORT:-22}" "$SERVER_USER@$SERVER_HOST" "mkdir -p \"$SERVER_DEPLOY_PATH\""
          rsync -az --delete \
            --exclude ".git" \
            --exclude ".venv" \
            --exclude "__pycache__" \
            --exclude ".env" \
            --exclude "config/devices.json" \
            ./ "$SERVER_USER@$SERVER_HOST:$SERVER_DEPLOY_PATH/"

      - name: Build and restart on server
        run: |
          ssh -p "${SERVER_PORT:-22}" "$SERVER_USER@$SERVER_HOST" \
            "cd \"$SERVER_DEPLOY_PATH\" && docker compose up -d --build"
